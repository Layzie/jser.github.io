// LICENSE : MIT
"use strict";
function isNode(node) {
  if (node == null) {
    return false;
  }
  return typeof node === "object" && (typeof node.type === "string" || typeof node.t === "string");
}
function TxtElement(node, path, wrap, ref) {
  this.node = node;
  this.path = path;
  this.wrap = wrap;
  this.ref = ref;
}

var BREAK = {}, SKIP = {}, REMOVE = {};
var VisitorOption = {
  Break: BREAK,
  Skip: SKIP,
  Remove: REMOVE
};
var Controller = function Controller() {};

Controller.prototype.__willStartTraverse = function (root, visitor) {
  this.__current = null;
  this.visitor = visitor;
  this.root = root;
  this.__worklist = [];
  this.__leavelist = [];
};

Controller.prototype.__execute = function (callback, element) {
  var previous, result;

  result = undefined;

  previous = this.__current;
  this.__current = element;
  if (callback) {
    result = callback.call(this, element.node, this.__leavelist[this.__leavelist.length - 1].node);
  }
  this.__current = previous;

  return result;
};

/**
 * Gets parent nodes of current node.
 * The parent nodes are returned in order from the closest parent to the outer ones.
 * Current node is {@link current}.
 * @returns {Array}
 * @public
 */
Controller.prototype.parents = function () {
  var result = [];
  for (var i = this.__leavelist.length - 1; i > 0; i--) {
    var parent = this.__leavelist[i].node;
    result.push(parent);
  }
  return result;
};

/**
 * Gets current node during traverse.
 * @returns {TxtNode}
 * @public
 */
Controller.prototype.current = function () {
  return this.__current.node;
};

Controller.prototype.traverse = function (root, visitor) {
  this.__willStartTraverse(root, visitor);

  var sentinel = {};

  // reference
  var worklist = this.__worklist;
  var leavelist = this.__leavelist;

  // initialize
  worklist.push(new TxtElement(root, null, null, null));
  leavelist.push(new TxtElement(null, null, null, null));

  while (worklist.length) {
    var element = worklist.pop();

    if (element === sentinel) {
      element = leavelist.pop();

      var ret = this.__execute(visitor.leave, element);

      if (ret === BREAK) {
        return;
      }
      continue;
    }

    if (element.node) {
      ret = this.__execute(visitor.enter, element);

      if (ret === BREAK) {
        return;
      }

      worklist.push(sentinel);
      leavelist.push(element);

      if (ret === SKIP) {
        continue;
      }

      var node = element.node;
      var nodeType = element.wrap || node.type;
      var candidates = Object.keys(node);

      var current = candidates.length;
      while ((current -= 1) >= 0) {
        var key = candidates[current];
        var candidate = node[key];
        if (!candidate) {
          continue;
        }

        if (Array.isArray(candidate)) {
          var current2 = candidate.length;
          while ((current2 -= 1) >= 0) {
            if (!candidate[current2]) {
              continue;
            }
            if (isNode(candidate[current2])) {
              element = new TxtElement(candidate[current2], [key, current2], null, null);
            } else {
              continue;
            }
            worklist.push(element);
          }
        } else if (isNode(candidate)) {
          worklist.push(new TxtElement(candidate, key, null, null));
        }
      }
    }
  }
};




function traverse(root, visitor) {
  var controller = new Controller();
  return controller.traverse(root, visitor);
}
exports.Controller = Controller;
exports.traverse = traverse;
exports.VisitorOption = VisitorOption;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInR4dC1hc3QtdHJhdmVyc2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0ksTUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO0FBQ2QsV0FBTyxLQUFLLENBQUM7R0FDaEI7QUFDRCxTQUFPLE9BQU8sSUFBSSxLQUFLLFFBQVEsS0FBSyxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUEsQUFBQyxDQUFDOzs7QUFHakcsTUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7OztJQUdiLEtBQUssR0FBRyxFQUFFLEVBQ1osSUFBSSxHQUFHLEVBQUUsRUFDVCxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLElBQU0sYUFBYSxHQUFHO0FBQ2xCLE9BQUssRUFBRSxLQUFLO0FBQ1osTUFBSSxFQUFFLElBQUk7QUFDVixRQUFNLEVBQUUsTUFBTTtDQUNqQixDQUFDO0lBQ0ksVUFBVSxZQUFWLFVBQVU7O0FBQVYsVUFBVSxXQUNaLG1CQUFtQixHQUFBLFVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRTtBQUMvQixNQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixNQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztBQUN2QixNQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNqQixNQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztBQUNyQixNQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztDQUV6Qjs7QUFSQyxVQUFVLFdBVVosU0FBUyxHQUFBLFVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRTtBQUN6QixNQUFJLFFBQVEsRUFBRSxNQUFNLENBQUM7O0FBRXJCLFFBQU0sR0FBRyxTQUFTLENBQUM7O0FBRW5CLFVBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0FBQzFCLE1BQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO0FBQ3pCLE1BQUksUUFBUSxFQUFFO0FBQ1YsVUFBTSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUNsRztBQUNELE1BQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDOztBQUUxQixTQUFPLE1BQU0sQ0FBQztDQUNqQjs7Ozs7Ozs7O0FBdkJDLFVBQVUsV0FnQ1osT0FBTyxHQUFBLFlBQUc7QUFDTixNQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDaEIsT0FBSyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNsRCxRQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUN0QyxVQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0dBQ3ZCO0FBQ0QsU0FBTyxNQUFNLENBQUM7Q0FDakI7Ozs7Ozs7QUF2Q0MsVUFBVSxXQThDWixPQUFPLEdBQUEsWUFBRztBQUNOLFNBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7Q0FDOUI7O0FBaERDLFVBQVUsV0FrRFosUUFBUSxHQUFBLFVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRTtBQUVwQixNQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDOztBQUV4QyxNQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7OztBQUdsQixNQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0FBQy9CLE1BQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7OztBQUdqQyxVQUFRLENBQUMsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDdEQsV0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLFVBQVUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDOztBQUV2RCxTQUFPLFFBQVEsQ0FBQyxNQUFNLEVBQUU7QUFDcEIsUUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDOztBQUU3QixRQUFJLE9BQU8sS0FBSyxRQUFRLEVBQUU7QUFDdEIsYUFBTyxHQUFHLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7QUFFMUIsVUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDOztBQUVqRCxVQUFJLEdBQUcsS0FBSyxLQUFLLEVBQUU7QUFDZixlQUFPO09BQ1Y7QUFDRCxlQUFTO0tBQ1o7O0FBRUQsUUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFO0FBRWQsU0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQzs7QUFFN0MsVUFBSSxHQUFHLEtBQUssS0FBSyxFQUFFO0FBQ2YsZUFBTztPQUNWOztBQUVELGNBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDeEIsZUFBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzs7QUFFeEIsVUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO0FBQ2QsaUJBQVM7T0FDWjs7QUFFRCxVQUFJLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO0FBQ3hCLFVBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQztBQUN6QyxVQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOztBQUVuQyxVQUFJLE9BQU8sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO0FBQ2hDLGFBQU8sQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFBLElBQUssQ0FBQyxFQUFFO0FBQ3hCLFlBQUksR0FBRyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM5QixZQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDMUIsWUFBSSxDQUFDLFNBQVMsRUFBRTtBQUNaLG1CQUFTO1NBQ1o7O0FBRUQsWUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO0FBQzFCLGNBQUksUUFBUSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7QUFDaEMsaUJBQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFBLElBQUssQ0FBQyxFQUFFO0FBQ3pCLGdCQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFO0FBQ3RCLHVCQUFTO2FBQ1o7QUFDRCxnQkFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7QUFDN0IscUJBQU8sR0FBRyxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQzlFLE1BQU07QUFDSCx1QkFBUzthQUNaO0FBQ0Qsb0JBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7V0FDMUI7U0FDSixNQUFNLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFO0FBQzFCLGtCQUFRLENBQUMsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDN0Q7T0FDSjtLQUNKO0dBQ0o7Q0FDSjs7Ozs7QUFJTCxTQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO0FBQzdCLE1BQUksVUFBVSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7QUFDbEMsU0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztDQUM3QztRQUVHLFVBQVUsR0FBVixVQUFVO1FBQ1YsUUFBUSxHQUFSLFFBQVE7UUFDUixhQUFhLEdBQWIsYUFBYSIsImZpbGUiOiJ0eHQtYXN0LXRyYXZlcnNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTElDRU5TRSA6IE1JVFxuXCJ1c2Ugc3RyaWN0XCI7XG5mdW5jdGlvbiBpc05vZGUobm9kZSkge1xuICAgIGlmIChub2RlID09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHlwZW9mIG5vZGUgPT09ICdvYmplY3QnICYmICh0eXBlb2Ygbm9kZS50eXBlID09PSAnc3RyaW5nJyB8fCB0eXBlb2Ygbm9kZS50ID09PSAnc3RyaW5nJyk7XG59XG5mdW5jdGlvbiBUeHRFbGVtZW50KG5vZGUsIHBhdGgsIHdyYXAsIHJlZikge1xuICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gICAgdGhpcy5wYXRoID0gcGF0aDtcbiAgICB0aGlzLndyYXAgPSB3cmFwO1xuICAgIHRoaXMucmVmID0gcmVmO1xufVxuXG5jb25zdCBCUkVBSyA9IHt9LFxuICAgIFNLSVAgPSB7fSxcbiAgICBSRU1PVkUgPSB7fTtcbmNvbnN0IFZpc2l0b3JPcHRpb24gPSB7XG4gICAgQnJlYWs6IEJSRUFLLFxuICAgIFNraXA6IFNLSVAsXG4gICAgUmVtb3ZlOiBSRU1PVkVcbn07XG5jbGFzcyBDb250cm9sbGVyIHtcbiAgICBfX3dpbGxTdGFydFRyYXZlcnNlKHJvb3QsIHZpc2l0b3IpIHtcbiAgICAgICAgdGhpcy5fX2N1cnJlbnQgPSBudWxsO1xuICAgICAgICB0aGlzLnZpc2l0b3IgPSB2aXNpdG9yO1xuICAgICAgICB0aGlzLnJvb3QgPSByb290O1xuICAgICAgICB0aGlzLl9fd29ya2xpc3QgPSBbXTtcbiAgICAgICAgdGhpcy5fX2xlYXZlbGlzdCA9IFtdO1xuXG4gICAgfVxuXG4gICAgX19leGVjdXRlKGNhbGxiYWNrLCBlbGVtZW50KSB7XG4gICAgICAgIHZhciBwcmV2aW91cywgcmVzdWx0O1xuXG4gICAgICAgIHJlc3VsdCA9IHVuZGVmaW5lZDtcblxuICAgICAgICBwcmV2aW91cyA9IHRoaXMuX19jdXJyZW50O1xuICAgICAgICB0aGlzLl9fY3VycmVudCA9IGVsZW1lbnQ7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2suY2FsbCh0aGlzLCBlbGVtZW50Lm5vZGUsIHRoaXMuX19sZWF2ZWxpc3RbdGhpcy5fX2xlYXZlbGlzdC5sZW5ndGggLSAxXS5ub2RlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9fY3VycmVudCA9IHByZXZpb3VzO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBwYXJlbnQgbm9kZXMgb2YgY3VycmVudCBub2RlLlxuICAgICAqIFRoZSBwYXJlbnQgbm9kZXMgYXJlIHJldHVybmVkIGluIG9yZGVyIGZyb20gdGhlIGNsb3Nlc3QgcGFyZW50IHRvIHRoZSBvdXRlciBvbmVzLlxuICAgICAqIEN1cnJlbnQgbm9kZSBpcyB7QGxpbmsgY3VycmVudH0uXG4gICAgICogQHJldHVybnMge0FycmF5fVxuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBwYXJlbnRzKCkge1xuICAgICAgICB2YXIgcmVzdWx0ID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9fbGVhdmVsaXN0Lmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHtcbiAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLl9fbGVhdmVsaXN0W2ldLm5vZGU7XG4gICAgICAgICAgICByZXN1bHQucHVzaChwYXJlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBjdXJyZW50IG5vZGUgZHVyaW5nIHRyYXZlcnNlLlxuICAgICAqIEByZXR1cm5zIHtUeHROb2RlfVxuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBjdXJyZW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fX2N1cnJlbnQubm9kZTtcbiAgICB9XG5cbiAgICB0cmF2ZXJzZShyb290LCB2aXNpdG9yKSB7XG5cbiAgICAgICAgdGhpcy5fX3dpbGxTdGFydFRyYXZlcnNlKHJvb3QsIHZpc2l0b3IpO1xuXG4gICAgICAgIHZhciBzZW50aW5lbCA9IHt9O1xuXG4gICAgICAgIC8vIHJlZmVyZW5jZVxuICAgICAgICB2YXIgd29ya2xpc3QgPSB0aGlzLl9fd29ya2xpc3Q7XG4gICAgICAgIHZhciBsZWF2ZWxpc3QgPSB0aGlzLl9fbGVhdmVsaXN0O1xuXG4gICAgICAgIC8vIGluaXRpYWxpemVcbiAgICAgICAgd29ya2xpc3QucHVzaChuZXcgVHh0RWxlbWVudChyb290LCBudWxsLCBudWxsLCBudWxsKSk7XG4gICAgICAgIGxlYXZlbGlzdC5wdXNoKG5ldyBUeHRFbGVtZW50KG51bGwsIG51bGwsIG51bGwsIG51bGwpKTtcblxuICAgICAgICB3aGlsZSAod29ya2xpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgZWxlbWVudCA9IHdvcmtsaXN0LnBvcCgpO1xuXG4gICAgICAgICAgICBpZiAoZWxlbWVudCA9PT0gc2VudGluZWwpIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50ID0gbGVhdmVsaXN0LnBvcCgpO1xuXG4gICAgICAgICAgICAgICAgdmFyIHJldCA9IHRoaXMuX19leGVjdXRlKHZpc2l0b3IubGVhdmUsIGVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJldCA9PT0gQlJFQUspIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZSkge1xuXG4gICAgICAgICAgICAgICAgcmV0ID0gdGhpcy5fX2V4ZWN1dGUodmlzaXRvci5lbnRlciwgZWxlbWVudCk7XG5cbiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBCUkVBSykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgd29ya2xpc3QucHVzaChzZW50aW5lbCk7XG4gICAgICAgICAgICAgICAgbGVhdmVsaXN0LnB1c2goZWxlbWVudCk7XG5cbiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBTS0lQKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudC5ub2RlO1xuICAgICAgICAgICAgICAgIHZhciBub2RlVHlwZSA9IGVsZW1lbnQud3JhcCB8fCBub2RlLnR5cGU7XG4gICAgICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZXMgPSBPYmplY3Qua2V5cyhub2RlKTtcblxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gY2FuZGlkYXRlcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgd2hpbGUgKChjdXJyZW50IC09IDEpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGNhbmRpZGF0ZXNbY3VycmVudF07XG4gICAgICAgICAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBub2RlW2tleV07XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2FuZGlkYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNhbmRpZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGNhbmRpZGF0ZS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGN1cnJlbnQyIC09IDEpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNhbmRpZGF0ZVtjdXJyZW50Ml0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc05vZGUoY2FuZGlkYXRlW2N1cnJlbnQyXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IG5ldyBUeHRFbGVtZW50KGNhbmRpZGF0ZVtjdXJyZW50Ml0sIFtrZXksIGN1cnJlbnQyXSwgbnVsbCwgbnVsbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtsaXN0LnB1c2goZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOb2RlKGNhbmRpZGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtsaXN0LnB1c2gobmV3IFR4dEVsZW1lbnQoY2FuZGlkYXRlLCBrZXksIG51bGwsIG51bGwpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5mdW5jdGlvbiB0cmF2ZXJzZShyb290LCB2aXNpdG9yKSB7XG4gICAgdmFyIGNvbnRyb2xsZXIgPSBuZXcgQ29udHJvbGxlcigpO1xuICAgIHJldHVybiBjb250cm9sbGVyLnRyYXZlcnNlKHJvb3QsIHZpc2l0b3IpO1xufVxuZXhwb3J0IHtcbiAgICBDb250cm9sbGVyLFxuICAgIHRyYXZlcnNlLFxuICAgIFZpc2l0b3JPcHRpb25cbiAgICB9OyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==